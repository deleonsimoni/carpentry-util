<div class="header bg-gradient-danger pb-8 pt-5 pt-md-8">
  <div class="container-fluid">
    <div class="header-body">
      <!-- Header with title and new takeoff button -->
      <div class="row align-items-center py-4">
        <div class="col-lg-6 col-7">
          <h6 class="h2 text-white d-inline-block mb-0">Takeoff Management</h6>
        </div>
        <div class="col-lg-6 col-5 text-right">
          <div *ngIf="isManager" class="text-right">
            <a (click)="newOrder()" class="btn btn-success btn-lg">
              <i class="fas fa-plus mr-2"></i>New Takeoff
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Page content -->
<div class="container-fluid mt--7">
  <!-- Table -->
  <div class="row">
    <div class="col">
      <div class="card shadow">
        <div class="card-header border-0">
          <h3 class="mb-0">List Takeoff</h3>

          <!-- Mobile-first responsive filters -->
          <div class="row">
            <!-- Search input - full width on mobile -->
            <div class="col-12 col-md-5 mb-3 mb-md-0">
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">
                    <i class="ni ni-zoom-split-in"></i>
                  </span>
                </div>
                <input
                  class="form-control"
                  placeholder="Search..."
                  type="text"
                  [(ngModel)]="searchTerm"
                  (input)="onSearchChange()"
                />
              </div>
            </div>

            <!-- Status filter - full width on mobile -->
            <div class="col-12 col-md-3 mb-3 mb-md-0">
              <select
                class="form-control"
                [(ngModel)]="selectedStatus"
                (change)="onStatusFilterChange()"
              >
                <option value="">All Status</option>
                <option value="1">Created</option>
                <option value="2">To Measure</option>
                <option value="3">Under Review</option>
                <option value="4">Ready to Ship</option>
                <option value="5">Shipped</option>
                <option value="6">Trimming Completed</option>
                <option value="7">Back Trim Completed</option>
                <option value="8">Closed</option>
              </select>
            </div>

            <!-- Action buttons - full width on mobile -->
            <div class="col-12 col-md-4">
              <div class="btn-group w-100" role="group">
                <button
                  class="btn btn-primary btn-sm"
                  type="button"
                  (click)="applyFilters()"
                >
                  <i class="fas fa-search mr-1"></i>
                  <span class="d-none d-sm-inline">Search</span>
                </button>
                <button
                  class="btn btn-secondary btn-sm"
                  type="button"
                  (click)="clearFilters()"
                >
                  <i class="fas fa-times mr-1"></i>
                  <span class="d-none d-sm-inline">Clear</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Empty state message -->
          <div *ngIf="filteredOrders && filteredOrders.length === 0" class="text-center py-5">
            <div class="mb-4">
              <i class="fas fa-inbox fa-4x text-muted"></i>
            </div>
            <h4 class="text-muted">No takeoffs found</h4>
            <p class="text-muted mb-4">{{ getEmptyStateMessage() }}</p>
            <button *ngIf="isManager" (click)="newOrder()" class="btn btn-primary">
              <i class="fas fa-plus mr-2"></i>Create New Takeoff
            </button>
          </div>

          <!-- Mobile cards view -->
          <div *ngIf="filteredOrders && filteredOrders.length > 0" class="d-block d-lg-none">
            <div class="row">
              <div class="col-12" *ngFor="let order of filteredOrders">
                <div class="card mb-3 shadow-sm">
                  <div class="card-body p-3">
                    <div class="row align-items-center">
                      <div
                        class="col-8"
                        style="cursor: pointer;"
                        (click)="detailOrder(order._id)"
                      >
                        <h6 class="mb-1">
                          <span class="text-primary">
                            <i class="fas fa-eye mr-2"></i>{{ order.custumerName | titlecase }}
                          </span>
                        </h6>
                        <p class="text-sm text-muted mb-1">
                          <strong>Job Site:</strong> {{ order.shipTo | titlecase }}
                        </p>
                        <p class="text-sm text-muted mb-1">
                          <strong>LOT:</strong> {{ order.lot | titlecase }}
                        </p>
                        <p class="text-sm text-muted mb-0">
                          {{ isManager ? order.carpentry?.fullname : (order.user?.fullname | titlecase) }}
                        </p>
                      </div>
                      <div class="col-4 text-right">
                        <div class="mb-2">
                          <app-takeoff-status
                            [currentStatus]="order.status"
                            [takeoffId]="order._id"
                            [canChange]="true"
                            [showActions]="true"
                            [isManager]="isManager"
                            [userRole]="userRole"
                            [customerName]="order.custumerName"
                            (statusChanged)="onStatusChanged(order._id, $event)"
                          ></app-takeoff-status>
                        </div>
                        <div ngbDropdown placement="bottom-left" (click)="$event.stopPropagation()">
                          <button
                            class="btn btn-sm btn-outline-secondary"
                            ngbDropdownToggle
                          >
                            <i class="fas fa-ellipsis-v"></i>
                          </button>
                          <div ngbDropdownMenu class="dropdown-menu-arrow">
                            <a class="dropdown-item" (click)="detailOrder(order._id)">
                              <i class="fas fa-eye mr-2"></i>Detail
                            </a>
                            <a
                              *ngIf="order.status === TakeoffStatus.TO_MEASURE && userRole === UserRoles.CARPENTER && order.carpentry?._id === user._id"
                              class="dropdown-item"
                              (click)="openMeasurements(order._id)"
                            >
                              <i class="fas fa-ruler mr-2"></i>Measurements
                            </a>
                            <a
                              *ngIf="order.status >= TakeoffStatus.UNDER_REVIEW && isManager"
                              class="dropdown-item"
                              (click)="geratePDF(order._id, order.shipTo, order.lot)"
                            >
                              <i class="fas fa-file-pdf mr-2"></i>Generate PDF
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Desktop table view -->
          <div *ngIf="filteredOrders && filteredOrders.length > 0" class="d-none d-lg-block table-responsive">
            <table class="table align-items-center table-flush table-hover">
              <thead class="thead-light">
                <tr>
                  <th scope="col">Customer</th>
                  <th scope="col">Job Site</th>
                  <th scope="col">LOT</th>
                  <th scope="col">Status</th>
                  <th scope="col">{{ isManager ? 'Carpentry' : 'Company' }}</th>
                  <th scope="col">Completion</th>
                  <th scope="col"></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let myOrder of filteredOrders">
                  <th scope="row">
                    <div class="media align-items-center">
                      <div class="media-body">
                        <span
                          class="mb-0 text-sm text-primary"
                          style="cursor: pointer; text-decoration: underline;"
                          (click)="detailOrder(myOrder._id)"
                        ><i class="fas fa-eye mr-2"></i>{{
                          myOrder.custumerName | titlecase
                        }}</span>
                      </div>
                    </div>
                  </th>

                  <td>
                    <div class="media-body">
                      <span class="mb-0 text-sm">
                        {{ myOrder.shipTo | titlecase }}
                      </span>
                    </div>
                  </td>

                  <td>
                    <div class="media-body">
                      <span class="mb-0 text-sm">
                        {{ myOrder.lot | titlecase }}
                      </span>
                    </div>
                  </td>

                  <td>
                    <app-takeoff-status
                      [currentStatus]="myOrder.status"
                      [takeoffId]="myOrder._id"
                      [canChange]="true"
                      [showActions]="true"
                      [isManager]="isManager"
                      [userRole]="userRole"
                      [customerName]="myOrder.custumerName"
                      (statusChanged)="onStatusChanged(myOrder._id, $event)"
                    ></app-takeoff-status>
                  </td>
                  <td>
                    <div class="avatar-group">
                      {{
                        isManager
                          ? myOrder.carpentry.fullname
                          : (myOrder.user.company.name | titlecase)
                      }}
                    </div>
                  </td>
                  <td>
                    <div
                      *ngIf="myOrder.status == 1"
                      class="d-flex align-items-center"
                    >
                      <span class="mr-2">10%</span>
                      <div>
                        <div class="progress">
                          <div
                            class="progress-bar bg-danger"
                            role="progressbar"
                            aria-valuenow="10"
                            aria-valuemin="0"
                            aria-valuemax="100"
                            style="width: 10%"
                          ></div>
                        </div>
                      </div>
                    </div>

                    <div
                      *ngIf="myOrder.status == 2"
                      class="d-flex align-items-center"
                    >
                      <span class="mr-2">50%</span>
                      <div>
                        <div class="progress">
                          <div
                            class="progress-bar bg-info"
                            role="progressbar"
                            aria-valuenow="10"
                            aria-valuemin="0"
                            aria-valuemax="100"
                            style="width: 50%"
                          ></div>
                        </div>
                      </div>
                    </div>

                    <div
                      *ngIf="myOrder.status == 0"
                      class="d-flex align-items-center"
                    >
                      <span class="mr-2">20%</span>
                      <div>
                        <div class="progress">
                          <div
                            class="progress-bar bg-success"
                            role="progressbar"
                            aria-valuenow="20"
                            aria-valuemin="0"
                            aria-valuemax="100"
                            style="width: 60%"
                          ></div>
                        </div>
                      </div>
                    </div>

                    <div
                      *ngIf="myOrder.status >= 3"
                      class="d-flex align-items-center"
                    >
                      <span class="mr-2">100%</span>
                      <div>
                        <div class="progress">
                          <div
                            class="progress-bar bg-success"
                            role="progressbar"
                            aria-valuenow="100"
                            aria-valuemin="0"
                            aria-valuemax="100"
                            style="width: 100%"
                          ></div>
                        </div>
                      </div>
                    </div>

                    <a
                      *ngIf="myOrder.status >= TakeoffStatus.UNDER_REVIEW"
                      (click)="geratePDF(myOrder._id, myOrder.shipTo, myOrder.lot)"
                      class="btn btn-primary"
                      >Generate PDF</a
                    >
                  </td>

                  <td class="text-right">
                    <div ngbDropdown placement="bottom-right">
                      <a
                        class="btn btn-sm btn-icon-only text-light"
                        ngbDropdownToggle
                      >
                        <i class="fas fa-ellipsis-v"></i>
                      </a>
                      <div
                        ngbDropdownMenu
                        class="dropdown-menu-right dropdown-menu-arrow"
                      >
                        <a
                          class="dropdown-item"
                          (click)="detailOrder(myOrder._id)"
                          ><i class="fas fa-eye mr-2"></i>Detail</a
                        >
                        <a
                          *ngIf="myOrder.status === TakeoffStatus.TO_MEASURE && userRole === UserRoles.CARPENTER && myOrder.carpentry?._id === user._id"
                          class="dropdown-item"
                          (click)="openMeasurements(myOrder._id)"
                          ><i class="fas fa-ruler mr-2"></i>Measurements</a
                        >
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- Pagination - only show when there's data -->
          <div *ngIf="filteredOrders && filteredOrders.length > 0" class="card-footer py-4">
            <nav aria-label="...">
              <ul class="pagination justify-content-end mb-0">
                <li class="page-item disabled">
                  <a class="page-link" href="javascript:void(0)" tabindex="-1">
                    <i class="fas fa-angle-left"></i>
                    <span class="sr-only">Previous</span>
                  </a>
                </li>
                <li class="page-item active">
                  <a class="page-link" href="javascript:void(0)">1</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="javascript:void(0)"
                    >2 <span class="sr-only">(current)</span></a
                  >
                </li>
                <li class="page-item">
                  <a class="page-link" href="javascript:void(0)">3</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="javascript:void(0)">
                    <i class="fas fa-angle-right"></i>
                    <span class="sr-only">Next</span>
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>