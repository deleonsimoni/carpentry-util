<div class="modal-header border-bottom-0 pb-0">
  <div class="d-flex align-items-center">
    <div class="icon-circle bg-primary mr-3">
      <i class="fas fa-calendar-plus text-white"></i>
    </div>
    <div>
      <h4 class="modal-title mb-0">{{ isEditMode ? 'Edit Event' : 'Register New Event' }}</h4>
      <p class="text-muted mb-0 text-sm">{{ isEditMode ? 'Update event information' : 'Fill in the event details' }}</p>
    </div>
  </div>
  <button type="button" class="btn-close" aria-label="Close" (click)="cancel()">
    <span aria-hidden="true">&times;</span>
  </button>
</div>

<div class="modal-body px-4 py-4">
  <div *ngIf="isLoading" class="text-center py-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <form *ngIf="!isLoading">
    <!-- Scheduled Date (Read-only display) -->
    <div class="form-group">
      <label class="form-control-label fw-bold text-dark mb-2">
        Scheduled Date
      </label>
      <div class="date-display">
        <i class="fas fa-calendar-day mr-2"></i>
        <span>{{ getFormattedDate() }}</span>
      </div>
    </div>

    <!-- Event Type -->
    <div class="form-group" *ngIf="!hasFixedEventType()">
      <label class="form-control-label fw-bold text-dark mb-2">
        Event Type <span class="text-danger">*</span>
      </label>
      <div class="event-type-selector">
        <div
          *ngFor="let type of eventTypes"
          class="event-type-option"
          [class.selected]="formData.type === type"
          [ngClass]="'type-' + type"
          (click)="selectEventType(type)"
        >
          <i [class]="getTypeIcon(type)"></i>
          <span>{{ getTypeLabel(type) }}</span>
        </div>
      </div>
    </div>

    <!-- Fixed Event Type Display -->
    <div class="form-group" *ngIf="hasFixedEventType()">
      <label class="form-control-label fw-bold text-dark mb-2">
        Event Type
      </label>
      <div class="event-type-display">
        <span class="badge badge-lg" [ngClass]="'badge-' + typeConfig[formData.type]?.color">
          <i [class]="getTypeIcon(formData.type) + ' mr-2'"></i>
          {{ getTypeLabel(formData.type) }}
        </span>
      </div>
    </div>

    <!-- Takeoff Selection (Multiple) -->
    <div class="form-group">
      <label class="form-control-label fw-bold text-dark mb-2">
        Select Takeoffs <span class="text-danger">*</span>
      </label>
      <select
        class="form-control form-control-alternative"
        (change)="onTakeoffSelect($event)"
      >
        <option value="">-- Add a Takeoff --</option>
        <option *ngFor="let takeoff of getAvailableTakeoffs()" [value]="takeoff._id">
          {{ getTakeoffDisplayName(takeoff) }}
        </option>
      </select>
      <small *ngIf="takeoffs.length === 0" class="text-muted d-block mt-1">
        <i class="fas fa-info-circle"></i> No takeoffs available
      </small>

      <!-- Selected Takeoffs List -->
      <div *ngIf="selectedTakeoffs.length > 0" class="selected-takeoffs mt-2">
        <div *ngFor="let takeoff of selectedTakeoffs" class="selected-takeoff-item">
          <div class="takeoff-info">
            <strong>{{ takeoff.shipTo || takeoff.streetName || 'No Jobsite' }}</strong>
            <span *ngIf="takeoff.lot" class="text-muted ml-1">- Lot {{ takeoff.lot }}</span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeTakeoff(takeoff._id)">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Title (Auto-generated, read-only) -->
    <div class="form-group">
      <label class="form-control-label fw-bold text-dark mb-2">
        Title
      </label>
      <input
        type="text"
        class="form-control form-control-alternative"
        [value]="formData.title"
        readonly
        placeholder="Select takeoffs to generate title"
      />
      <small class="text-muted">Auto-generated from selected takeoffs</small>
    </div>

    <!-- Assigned To (Hidden for Delivery, Required for Trim) -->
    <div class="form-group" *ngIf="!isDelivery()">
      <label class="form-control-label fw-bold text-dark mb-2">
        Assigned To <span class="text-danger">*</span>
      </label>
      <select
        class="form-control form-control-alternative"
        [(ngModel)]="formData.assignedTo"
        name="assignedTo"
        [class.is-invalid]="!formData.assignedTo"
      >
        <option value="">-- Select Team Member --</option>
        <option *ngFor="let member of teamMembers" [value]="member._id">
          {{ member.fullname }} ({{ member.profile | titlecase }})
        </option>
      </select>
      <small class="text-muted">Required for trim installations</small>
    </div>
  </form>
</div>

<div class="modal-footer border-top-0 pt-0 px-4 pb-4">
  <div class="d-flex justify-content-between w-100">
    <div>
      <button
        *ngIf="isEditMode"
        type="button"
        class="btn btn-outline-danger"
        (click)="delete()"
      >
        <i class="fas fa-trash-alt mr-2"></i>Delete
      </button>
    </div>
    <div>
      <button type="button" class="btn btn-outline-secondary mr-2" (click)="cancel()">
        <i class="fas fa-times mr-2"></i>Cancel
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="save()"
        [disabled]="!isFormValid()"
      >
        <i class="fas fa-save mr-2"></i>{{ isEditMode ? 'Update Event' : 'Save Event' }}
      </button>
    </div>
  </div>
</div>
